<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="mobile-view">
  <template>
    <style>
      :host {
	    display: inline-block;
	    width:100%;
	  	height:100%;
	  	position: relative;
	  }
	  .page{
		position: relative;
		height:100%;
		overflow:hidden;
	  }
	  .background{
	  	width:100%;
	  	position: absolute;
	  	left:0px;
	  	z-index:-1;
	  	transition:all 0.5s;
	  }
	  .background-blur{
	  	width:100%;
	  	position: absolute;
	  	left:0px;
	  	z-index:0;
	  	transition:all 0.5s;
	  	animation-name: blur;
	  	animation-iteration-count: infinite;
	  	animation-duration: 2s;
	  	animation-fill-mode: backwards;
	  }
	  @keyframes blur{
		0%   { opacity: 0;}
		50%   { opacity: 0.5;}
		55%   { opacity: 0.1;}
		60%   { opacity: 0.75;}
  		100% { opacity: 0;}
	  }
	  .background-1{
	  	top:0px;
	  }
	  .background-2{
	  	top:-80px;
	  	transform:scale(1.2);
	  }
	  .background-3{
	  	top:-800px;
	  }
	  .part{
	  	height:100%;
	  	width:100%;
	  	position: absolute;
	  	top:0px;
	  	left:0px;
	  	z-index:1;
	  	transition:all 0.5s;
	  }
	  .part-previous{
	  	top:-100%;
	  }
	  .part-next{
	  	top:100%;
	  }
	  .top{
		position: absolute;
		top:20px;
		width:100%;
		text-align:center;
		z-index: 3;
	  }
	  .title{
		font-size:72px;
		font-weight: 900;
		color:#fff;
		text-align: center;
		text-shadow:0px 10px 10px rgba(72,60,108,0.25);
		text-transform: uppercase;
	  }
	  .sub-title{
		font-size:24px;
		font-weight: 900;
		color:#fff;
		text-align: center;
		text-shadow:0px 10px 10px rgba(72,60,108,0.25);
		text-transform: uppercase;
		position: relative;
		top:5px;
	  }
	  .bottom{
		position: absolute;
		bottom:20px;
		width:100%;
		z-index: 3;
	  }
	  .big-button{
		border-radius: 100px;
		padding-top:26px;
		padding-bottom:34px;
		font-size:16px;
		color:#493d6b;
		background: #fff;
		box-shadow:0px 10px 10px rgba(72,60,108,0.5),
		0px -8px 0px 0px rgba(72,60,108,0.15) inset;
		text-transform: uppercase;
		font-weight: 900;
		width:calc(100% - 40px);
		margin:0px 20px;
		text-align:center;
	  }
	  .textbox{
		border-radius: 100px;
		padding-top:26px;
		padding-bottom:34px;
		font-size:16px;
		color:#493d6b;
		background: #fff;
		box-shadow:0px 10px 10px rgba(72,60,108,0.5),
		0px -8px 0px 0px rgba(72,60,108,0.15) inset;
		text-transform: uppercase;
		font-weight: 900;
		width:calc(100% - 40px);
		margin:0px 20px;
		text-align:center;
		border:none;
		font-family: "Google Sans";
		margin-bottom:10px;
	  }
	  .pop{
	  	position: absolute;
	  	top:0px;
	  	left:0px;
	  	height:100%;
	  	width:100%;
	  	background: rgba(72,60,108,0.9);
	  	color:#fff;
	  	font-size:24px;
	  	z-index: 4;
	  	opacity:0;
	  	user-select: none;
	  	pointer-events: none;
	  	transition:all 0.2s;
	  }
	  .pop-active{
	  	opacity:1;
	  	user-select: auto;
	  	pointer-events: auto;
	  }
	  .center{
	  	top:50%;
	  	left:50%;
		position: absolute;
		transform:translateX(-50%) translateY(-50%);
		text-align:center;
	  }
	  .info{
	  	color:#fff;
	  	font-size:16px;
	  	text-transform: uppercase;
	  	font-weight:900;
	  	text-align: center;
	  	text-shadow:0px 10px 10px rgba(72,60,108,0.25);
	  }
    </style>

    <app-location route="{{route}}"></app-location>

    <iron-ajax id="createPlayer" method="POST" url="../../src/webservices/createPlayer.php" content-type="application/json" handle-as="json" on-response="handleResponse">
    </iron-ajax>

    <iron-ajax id="refreshPlayers" method="POST" url="../../src/webservices/refreshPlayers.php" content-type="application/json" handle-as="json" on-response="playersConnect" last-response="{{players}}">
    </iron-ajax>

    <app-route route="{{route}}" pattern="/:view" data="{{routeData}}" tail="{{subroute}}"></app-route>
	
	<div class="page">

	<div class="part part-focus" id="home">
		<div class="top">
			<div class="sub-title">
				Bienvenue dans
			</div>
			<div class="title">
				LE JEU
			</div>
		</div>
		<div class="bottom">
			<div class="big-button" on-click="nextStep">
				Toucher pour jouer
			</div>
		</div>
    </div>
	
	<div class="part part-next" id="connect">
		<div class="top">
			<div class="sub-title">
				Rejoindre une partie
			</div>
		</div>
		<div class="pop" id="load">
			<div class="center">
				En attente des joueurs<br><br>
				<div id="player1"></div>
				<div id="player2"></div>
				<div id="player3"></div>
			</div>
		</div>
		<div class="bottom">
			<div class="info">Choisissez une planète</div>
			<input type="text" class="textbox" id="code" placeholder="...">
			<div class="info">Choisissez un pseudo</div>
			<input type="text" class="textbox" id="pseudo" placeholder="PSEUDO">
			<div class="info">-</div>
			<div class="big-button" on-click="connect">
				Se connecter
			</div>
		</div>
    </div>
	
	<div class="part part-next" id="game">
		<div class="top">
			<div class="sub-title">
				Vous êtes connecté
			</div>
		</div>
		<div class="bottom">
			<div class="big-button" on-click="nextStep">
				Valider
			</div>
		</div>
    </div>

	<img src="../../src/img/mobile-background-blur.png" id="backgroundBlur" class="background-blur" alt="">
	<img src="../../src/img/mobile-background.png" id="background" class="background" alt="">

    </div>

  </template>

  <script>/**
 * @customElement
 * @polymer
 */
class MobileView extends Polymer.Element {
  static get is() {
    return 'mobile-view';
  }

  static get properties() {
    return {
      step: {
        observer: 'stepChanged'
      }
    };
  }

  start() {
    this.set('step', "home");

    if (this.$_GET('code')) {
      this.$.code.value = this.$_GET('code');
      this.set('step', "connect");
    }

    var rand = Math.floor(Math.random() * 99 + 1);
    var playerID = "player" + rand;
    this.$.pseudo.value = playerID;
  }

  backStep() {
    if (this.step == "connect") {
      this.set('step', "home");
    }

    if (this.step == "game") {
      this.set('step', "connect");
    }
  }

  nextStep() {
    console.log(this.step);

    if (this.step == "home") {
      this.set('step', "connect");
    } else if (this.step == "connect") {
      this.set('step', "game");
    }
  }

  stepChanged() {
    console.log(this.step);
    this.$.home.className = "part";
    this.$.connect.className = "part";
    this.$.game.className = "part";
    this.$.background.className = "background";
    this.$.backgroundBlur.className = "background-blur";

    if (this.step == "home") {
      this.$.home.classList.add("part-focus");
      this.$.connect.classList.add("part-next");
      this.$.game.classList.add("part-next");
      this.$.background.classList.add("background-1");
      this.$.backgroundBlur.classList.add("background-1");
    } else if (this.step == "connect") {
      this.$.home.classList.add("part-previous");
      this.$.connect.classList.add("part-focus");
      this.$.game.classList.add("part-next");
      this.$.background.classList.add("background-2");
      this.$.backgroundBlur.classList.add("background-2");
    } else if (this.step == "game") {
      this.$.home.classList.add("part-previous");
      this.$.connect.classList.add("part-previous");
      this.$.game.classList.add("part-focus");
      this.$.background.classList.add("background-3");
      this.$.backgroundBlur.classList.add("background-3");
    }
  }

  connect() {
    var playerID = this.$.pseudo.value;
    this.set('code', this.$.code.value);
    this.$.createPlayer.body = '{"code": "' + this.code + '","playerID": "' + playerID + '"}';
    this.$.createPlayer.generateRequest();
    this.$.load.classList.add("pop-active");
    this.refreshPlayers();
  }

  refreshPlayers() {
    var self = this;
    setTimeout(function () {
      self.$.refreshPlayers.body = '{"code": "' + self.code + '"}';
      self.$.refreshPlayers.generateRequest();
      console.log("check players : " + self.code);

      if (self.player1 && self.player2 && self.player3) {
        setTimeout(function () {
          self.$.load.classList.remove("pop-active");
          self.set('step', "game");
        }, 2000);
        return;
      }

      self.refreshPlayers();
    }, 1000);
  }

  playersConnect() {
    var players = this.$.refreshPlayers.lastResponse;

    if (this.$.refreshPlayers.lastResponse[0]) {
      this.set('player1', this.$.refreshPlayers.lastResponse[0]);
      this.$.player1.innerHTML = this.player1;
    } else {
      this.set('player1', null);
      this.$.player1.innerHTML = "...";
    }

    if (this.$.refreshPlayers.lastResponse[1]) {
      this.set('player2', this.$.refreshPlayers.lastResponse[1]);
      this.$.player2.innerHTML = this.player2;
    } else {
      this.set('player2', null);
      this.$.player2.innerHTML = "...";
    }

    if (this.$.refreshPlayers.lastResponse[2]) {
      this.set('player3', this.$.refreshPlayers.lastResponse[2]);
      this.$.player3.innerHTML = this.player3;
    } else {
      this.set('player3', null);
      this.$.player3.innerHTML = "...";
    }
  }

  $_GET(param) {
    var vars = {};
    window.location.href.replace(location.hash, '').replace(/[?&]+([^=&]+)=?([^&]*)?/gi, // regexp
    function (m, key, value) {
      // callback
      vars[key] = value !== undefined ? value : '';
    });

    if (param) {
      return vars[param] ? vars[param] : null;
    }

    return vars;
  }

}

window.customElements.define(MobileView.is, MobileView);</script>
</dom-module>
