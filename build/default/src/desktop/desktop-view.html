<script src="../../vendor/qrcode/qrcode.js"></script>

<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="desktop-view">
  <template>
    <style>

	  :host {
	    display: inline-block;
	    width:100%;
	  	height:100%;
	  	position: relative;
	  	background: url(../img/space.png) no-repeat center center fixed; 
		-webkit-background-size: cover;
		-moz-background-size: cover;
		-o-background-size: cover;
		background-size: cover;
	  }

	  .page{
		padding:60px;
		background: #fff;
		display: inline-block;
		position: relative;
		border-radius:10px;
		box-shadow: 0px 20px 30px rgba(0,0,0,0.2),
		0px -10px 0px 0px rgba(0,0,0,0.05) inset;
		height:calc(100% - 240px);
		width:calc(100% - 240px);
	  }

	  .center{
	  	top:50%;
	  	left:50%;
	  	position: absolute;
	  	display: inline-block;
	  	transform:translateX(-50%) translateY(-50%);
	  	text-align: center;
	  }

	  .qrcode-container{
	  	position: relative;
	  	width: 200px;
		height: 200px;
		display: inline-block;
	  }

	  .qrcode-container .qrcode{
	  	display: inline-block;
	  	position: absolute;
	  	top:0px;
	  	left:0px;
	  	width: 100%;
		height: 100%;
		z-index:2;
	  }

	  .qrcode-container img{
	  	display: inline-block;
	  	position: absolute;
	  	top:25px;
	  	left:25px;
	  	width: calc(100% - 50px);
		height: calc(100% - 50px);
		z-index:1;
	  }

	  .separe{
	  	height:20px;
	  }

	  .code{
	  	color:#483c6c;
	  	font-size:24px;
		font-weight:900;
		display: inline-block;
	  }

    </style>

    <iron-ajax id="createParty" method="POST" url="../../src/webservices/createParty.php" content-type="application/json" handle-as="json">
    </iron-ajax>

    <iron-ajax id="refreshPlayers" method="POST" url="../../src/webservices/refreshPlayers.php" content-type="application/json" handle-as="json" on-response="playersConnect" last-response="{{players}}">
    </iron-ajax>

    <div class="page center">
    	<div class="center">
	    	<div class="qrcode-container">
				<div class="qrcode" id="qrcode"></div>
				<img src="../../src/img/qrcodespace.png" alt="">
			</div>
			<div class="separe"></div>
			<div class="code" id="code"></div>
		</div>
    </div>
  </template>

  <script>/**
 * @customElement
 * @polymer
 */
class DesktopView extends Polymer.Element {
  static get is() {
    return 'desktop-view';
  }

  static get properties() {
    return {};
  }

  start() {
    var rand = Math.floor(Math.random() * 99 + 1);
    var pick = Math.floor(Math.random() * 4);
    var planets = ["TERRE", "ORION", "MARS", "VENUS", "LUNE"];
    this.set('code', planets[pick] + rand);
    this.$.code.innerHTML = "#" + this.code;
    var qrcode = new QRCode(this.$.qrcode, {
      text: "http://thomaspaul.fr/?code=" + this.code,
      width: 200,
      height: 200,
      colorDark: "rgba(0,0,0,0)",
      colorLight: "#fff",
      correctLevel: QRCode.CorrectLevel.H
    });
    this.$.createParty.body = JSON.stringify(this.code);
    this.$.createParty.generateRequest();
    this.refreshPlayers();
  }

  playersConnect() {
    var players = this.$.refreshPlayers.lastResponse;
    this.set('player1', this.$.refreshPlayers.lastResponse[0]);
    this.set('player2', this.$.refreshPlayers.lastResponse[1]);
    this.set('player3', this.$.refreshPlayers.lastResponse[2]);
  }

  refreshPlayers() {
    var self = this;
    setTimeout(function () {
      self.$.refreshPlayers.body = '{"code": ' + self.code + '}';
      self.$.refreshPlayers.generateRequest();
      console.log("check players : " + self.code);
      self.refreshPlayers();
    }, 1000);
  }

}

window.customElements.define(DesktopView.is, DesktopView);</script>
</dom-module>
